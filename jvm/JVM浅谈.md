---
typora-copy-images-to: ..\raw
typora-root-url: ./
---

## JVM浅谈

#### 一.java虚拟机的内部体系结构

![微信截图_20171226173720](../raw/微信截图_20171226173720-4281163205.png)

![微信截图_20171226174557](../raw/微信截图_20171226174557.png)

***

#### 二.java堆

​	在堆的管理上，Sun JDK从1.2版本开始引入分代管理方式。主要分为新生代、旧生代，分代方式大大改善了垃圾回收的效率。

* **新生代(New Generation)**
  大多数情况下新创建的对象被分配在新生代中，新生代由**Eden Space**和两块相同大小的**Survivor Space**组成。

* **旧生代(Old Generation/Tenuring Generationg)**

  在**新生代**中存活时间较久的对象将会被转入**旧生代**，旧生代进行垃圾回收的频率没有新生代高

***

#### 三.java方法区

**类型信息**和类的**静态变量**都存储在**方法区**中。**方法区**中对于每个类存储了以下数据：

1. 类及其父类的全限定名(java.lang.Object没有父类)

2. 类的类型(Class or Interface)

3. 访问修饰符(public、abstract、final)

4. 实现的接口的全限定名的列表

5. 常量池

6. 字段信息

7. 方法信息

8. 静态变量

9. ClassLoader的引用

10. Class的引用

    可见类的所有信息都存储在方法区中。由于方法区所有的线程是共享的，所以必须保证线程安全。

举例来说，如果两个类同时加载一个尚未被加载的类，那么一个类会请求它的ClassLoader去加载需要的类，另一个类只能等待而不会重复加载。

#### 四.栈、堆、方法区交互

![微信截图_20171226182723](../raw/微信截图_20171226182723.png)

#### 五.元空间

**元空间：再见PermGen，你好MetaSpace**

1. 永久代在JDK8中被完全移除了。所以永久代的参数-XX：PermSize和 -XX：MaxPermSize也被移除了。
2. JDK8以后，JVM不再有PermGen。但类的元数据信息(metadata)还在，只不过不再是存储在连续的堆空间上，而是移动到叫做"Metaspace"的本地内存(Native Memory)中。

原因：类的元数据信息转移到Metaspace的原因是PermGen很难调整。PermGen中类的元数据信息在每次FullGC的时候可能会被收集，但成绩很难令人满意。而且应该为PermGen分配多大的空间很难确定，因为PermSize的大小依赖于很多因素，比如JVM加载的Class的总数，常量池的大小，方法的大小等。

***

#### 六.永久代的移除

​	**永久代的移除对最终用户意味着什么？**

​	由于类的元数据可以在本地内存(Native Memory)之外分配，所以其最大可利用空间是整个内存的可用空间。这样，你将不再会遇到OOM错误，溢出的内存也会拥入到交换空间。最终用户可以为类元数据指定最大可利用的本地内存空间，JVM也可以增加本地内存空间来满足类元数据信息存储。

​	注：永久代的移除并不意味着类加载器泄露的问题就没有了。因此，你仍然需要监控你的消费和计划，因为内存泄露会耗尽本地内存，导致内存交换(swapping)，这样只会变得更糟。

***

#### 七.JVM参数

​	-Xms和-Xmx设为一样大

​	JVM的堆大小决定了JVM花费在收集垃圾上的时间和频度。

​	如果堆的大小很大，那么完全垃圾收集就会很慢，但是频度会降低。

​	如果堆得大小和内存的需要一致，完全收集就会很快，但是会更加频繁。

​	调整堆大小的目的是最小化垃圾收集时间，以在特定的时间内最大化处理客户的请求。

​	一次完全的垃圾收集应该不超过3-5秒。如果垃圾收集成为瓶颈，那么需要指定堆的大小，检查垃圾收集的详细输出，研究垃圾收集参数堆性能的影响。我们一般把-Xms和-Xmx设为一样大，而堆的最大值受限于系统使用的物理内存。一般使用数据量较大的应用程序会使用持久对象，内存使用有可能迅速地增长。当应用程序需要的内存超出堆的最大值时虚拟机就会提示内存溢出，并且导致应用程序崩溃。因此一般建议堆的最大值设置为可用内存最大值的80%。

​	-Xms == -Xmx？	Not Alway！

* 设置-Xms的堆预期大小
  * 堆调整的代价很大
* ​

​	